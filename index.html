<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birthday Keeper — Segna i compleanni</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--danger:#ff7a7a}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:linear-gradient(180deg,#071022 0%,#081326 60%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .wrap{width:100%;max-width:980px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    form .row{display:flex;gap:8px;margin-bottom:8px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text], input[type=date], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#042026;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .list{max-height:60vh;overflow:auto;padding:8px}
    .item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.015), transparent)}
    .avatar{width:52px;height:52px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;background:rgba(255,255,255,0.03);font-size:18px}
    .meta{flex:1}
    .meta b{display:block}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px}
    .badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}
    footer.tools{display:flex;gap:8px;margin-top:10px;align-items:center}
    .topbar{display:flex;gap:8px;align-items:center}
    input[type=file]{display:none}
    @media (max-width:800px){.grid{grid-template-columns:1fr;}.card{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Birthday Keeper</h1>
        <p class="lead">Segna e tieni a mente i compleanni degli amici — tutto sul browser, salvato localmente.</p>
      </div>
      <div class="topbar">
        <button id="exportJsonBtn" class="ghost">Esporta JSON</button>
        <button id="exportCsvBtn" class="ghost">Esporta CSV</button>
        <label class="ghost" title="Importa file JSON/CSV"><input type="file" id="importFile" accept=".json,.csv">Importa</label>
        <button id="clearAll" class="ghost">Elimina tutto</button>
      </div>
    </header>

    <main class="grid">
      <section class="card" aria-labelledby="formTitle">
        <h2 id="formTitle">Aggiungi / Modifica</h2>
        <form id="birthdayForm">
          <input type="hidden" id="editId">
          <div class="row">
            <div style="flex:1">
              <label for="name">Nome</label>
              <input id="name" type="text" placeholder="Mario Rossi" required>
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label for="date">Data di nascita</label>
              <input id="date" type="date" required>
            </div>
            <div style="width:120px">
              <label for="yearOptional">Anno (opz.)</label>
              <input id="yearOptional" type="text" placeholder="1990">
            </div>
          </div>
          <div style="margin-bottom:8px">
            <label for="note">Nota</label>
            <textarea id="note" rows="3" placeholder="Es: ama i gatti"></textarea>
          </div>
          <div style="display:flex;gap:8px">
            <button type="submit">Salva</button>
            <button type="button" id="resetBtn" class="ghost">Annulla</button>
          </div>
        </form>

        <hr style="opacity:0.06;margin:12px 0">
        <div class="muted" style="font-size:13px;margin-bottom:8px">Filtri</div>
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input id="search" type="text" placeholder="Cerca nome...">
          <select id="filter">
            <option value="all">Tutti</option>
            <option value="30">Prossimi 30 giorni</option>
            <option value="7">Prossimi 7 giorni</option>
          </select>
        </div>

        <div class="muted">Suggerimento: il sito salva i dati nel browser (localStorage). Puoi esportare per backup.</div>
      </section>

      <section class="card">
        <h2>Elenco compleanni</h2>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:10px 0">
          <div class="muted" id="countLabel">0 amici</div>
          <div class="muted">Oggi: <span id="todayLabel">—</span></div>
        </div>

        <div class="list" id="list"></div>

        <footer class="tools">
          <div class="muted">Ordina per:</div>
          <button class="ghost" id="sortUpcoming">Prossimi</button>
          <button class="ghost" id="sortName">Nome</button>
        </footer>
      </section>
    </main>
  </div>

  <script>
    // Simple unique id generator
    const uid = ()=>Math.random().toString(36).slice(2,9);

    const STORAGE_KEY = 'birthday_keeper_v1';
    const defaultData = [];

    // Helpers for dates
    function parseDateInput(val){ // val like '1990-05-30' or '2025-08-13'
      if(!val) return null; const parts = val.split('-'); return new Date(parts[0], parts[1]-1, parts[2]);
    }

    function daysUntil(d){
      const today = new Date();
      const target = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      if(+target < +new Date(today.getFullYear(), today.getMonth(), today.getDate())){
        target.setFullYear(today.getFullYear()+1);
      }
      const diff = Math.ceil((target - new Date(today.getFullYear(), today.getMonth(), today.getDate()))/ (1000*60*60*24));
      return diff;
    }

    function nextOccurrenceFromDOB(dob){
      // dob: Date with the original birth date (year included)
      const today = new Date();
      let next = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
      if(+next < +new Date(today.getFullYear(), today.getMonth(), today.getDate())) next.setFullYear(next.getFullYear()+1);
      return next;
    }

    // Storage
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : defaultData.slice();
      }catch(e){console.error(e); return defaultData.slice();}
    }
    function save(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    // UI nodes
    const form = document.getElementById('birthdayForm');
    const nameIn = document.getElementById('name');
    const dateIn = document.getElementById('date');
    const yearOpt = document.getElementById('yearOptional');
    const noteIn = document.getElementById('note');
    const editId = document.getElementById('editId');
    const listNode = document.getElementById('list');
    const countLabel = document.getElementById('countLabel');
    const todayLabel = document.getElementById('todayLabel');
    const searchIn = document.getElementById('search');
    const filterIn = document.getElementById('filter');

    let data = load();
    let sortMode = 'upcoming';

    // Render
    function render(){
      // compute derived fields
      const today = new Date();
      const todayStr = today.toLocaleDateString();
      todayLabel.textContent = todayStr;

      let items = data.map(x=>{
        const dob = parseDateInput(x.date);
        const next = nextOccurrenceFromDOB(dob);
        const days = daysUntil(dob);
        const age = x.year ? (new Date().getFullYear() - Number(x.year)) : null;
        return {...x, dob: dob.toISOString().slice(0,10), next, days, age};
      });

      // filtering
      const q = searchIn.value.trim().toLowerCase();
      if(q) items = items.filter(i=>i.name.toLowerCase().includes(q));
      const f = filterIn.value;
      if(f==='7') items = items.filter(i=>i.days<=7);
      if(f==='30') items = items.filter(i=>i.days<=30);

      // sorting
      if(sortMode==='upcoming') items.sort((a,b)=>a.days - b.days);
      else items.sort((a,b)=>a.name.localeCompare(b.name));

      countLabel.textContent = items.length + (items.length===1? ' amico' : ' amici');

      listNode.innerHTML = '';
      if(items.length===0){ listNode.innerHTML = '<div class="muted">Nessun compleanno trovato.</div>'; return }

      for(const it of items){
        const el = document.createElement('div'); el.className='item';
        const abbr = document.createElement('div'); abbr.className='avatar'; abbr.textContent = it.name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
        const meta = document.createElement('div'); meta.className='meta';
        const title = document.createElement('b'); title.textContent = it.name + (it.age ? ` — ${it.age} anni` : '');
        const sub = document.createElement('div'); sub.className='muted';
        const dt = new Date(it.dob);
        sub.textContent = `Compleanno: ${dt.toLocaleDateString()} • tra ${it.days} giorno${it.days===1?'':'i'}`;
        if(it.note) sub.textContent += ` • ${it.note}`;
        meta.appendChild(title); meta.appendChild(sub);

        const actions = document.createElement('div'); actions.className='actions';
        const when = document.createElement('div'); when.className='badge'; when.textContent = it.days===0? 'Oggi' : `${it.days}g`;
        const editBtn = document.createElement('button'); editBtn.className='ghost'; editBtn.textContent='Modifica'; editBtn.onclick = ()=>startEdit(it.id);
        const delBtn = document.createElement('button'); delBtn.className='ghost'; delBtn.textContent='Elimina'; delBtn.onclick = ()=>deleteItem(it.id);
        actions.appendChild(when); actions.appendChild(editBtn); actions.appendChild(delBtn);

        el.appendChild(abbr); el.appendChild(meta); el.appendChild(actions);
        listNode.appendChild(el);
      }
    }

    // CRUD
    function addItem(obj){ data.push(obj); save(data); render(); }
    function updateItem(id, patch){ data = data.map(x=> x.id===id ? {...x, ...patch} : x); save(data); render(); }
    function deleteItem(id){ if(!confirm('Eliminare questo compleanno?')) return; data = data.filter(x=>x.id!==id); save(data); render(); }

    function startEdit(id){ const it = data.find(x=>x.id===id); if(!it) return; editId.value = id; nameIn.value = it.name; dateIn.value = it.date; yearOpt.value = it.year||''; noteIn.value = it.note||''; }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const name = nameIn.value.trim(); const date = dateIn.value; const year = yearOpt.value.trim(); const note = noteIn.value.trim();
      if(!name || !date){ alert('Compila nome e data.'); return; }
      const id = editId.value;
      if(id){ updateItem(id, {name, date, year: year||null, note: note||null}); editId.value=''; }
      else { addItem({id:uid(), name, date, year: year||null, note: note||null}); }
      form.reset();
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{ form.reset(); editId.value=''; });

    // Sorting & controls
    document.getElementById('sortUpcoming').addEventListener('click', ()=>{ sortMode='upcoming'; render(); });
    document.getElementById('sortName').addEventListener('click', ()=>{ sortMode='name'; render(); });

    searchIn.addEventListener('input', ()=>render());
    filterIn.addEventListener('change', ()=>render());

    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!confirm('Eliminare tutti i compleanni salvati?')) return; data=[]; save(data); render();
    });

    // Export / Import
    function download(filename, text){ const a=document.createElement('a'); a.href='data:application/octet-stream;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click(); }

    document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
      download('compleanni.json', JSON.stringify(data, null, 2));
    });

    function toCSV(arr){
      const rows = [['id','name','date','year','note']];
      for(const r of arr) rows.push([r.id, r.name, r.date, r.year||'', r.note||'']);
      return rows.map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    }
    document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
      download('compleanni.csv', toCSV(data));
    });

    document.getElementById('importFile').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return; const txt = await f.text();
      if(f.name.toLowerCase().endsWith('.json')){
        try{ const parsed = JSON.parse(txt);
          if(!Array.isArray(parsed)) throw new Error('JSON non è array');
          // naive merge: keep existing and add new unique ids
          const existingIds = new Set(data.map(d=>d.id));
          for(const it of parsed){ if(!it.id) it.id = uid(); if(existingIds.has(it.id)) it.id = uid(); data.push(it); }
          save(data); render(); alert('Import JSON completato');
        }catch(err){ alert('Errore import JSON: ' + err.message); }
      }else{
        // try CSV parse (very simple)
        const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        const rows = lines.map(l=>{ // naive split by comma, handling quoted cells
          const cols = []; let cur=''; let inq=false;
          for(let i=0;i<l.length;i++){ const ch=l[i]; if(ch==='"'){ inq=!inq; continue; } if(ch===',' && !inq){ cols.push(cur); cur=''; } else cur+=ch; } cols.push(cur); return cols; });
        const header = rows[0].map(h=>h.toLowerCase());
        for(let i=1;i<rows.length;i++){ const r = rows[i]; const obj = {};
          for(let j=0;j<header.length;j++){ obj[header[j]] = r[j]||''; }
          obj.id = obj.id || uid(); data.push({id:obj.id, name:obj.name||('Item'+i), date:obj.date||'', year:obj.year||null, note:obj.note||null});
        }
        save(data); render(); alert('Import CSV completato');
      }
      ev.target.value='';
    });

    // initialize with a small demo if empty
    if(data.length===0){ data = [

    render();

    // Optional: show a browser notification for today's birthdays (permissions requested once)
    function notifyToday(){
      if(!('Notification' in window)) return;
      const today = new Date(); const todayStr = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString().slice(0,10);
      const todays = data.filter(d=>d.date===todayStr || d.date.slice(5) === todayStr.slice(5));
      if(todays.length===0) return;
      if(Notification.permission === 'default') Notification.requestPermission();
      if(Notification.permission === 'granted'){
        const title = todays.length===1? `${todays[0].name} compie gli anni oggi!` : `Oggi ${todays.length} amici compiono gli anni!`;
        new Notification(title, {body: 'Apri Birthday Keeper per vedere i dettagli.'});
      }
    }
    // call on load
    setTimeout(notifyToday, 600);
  </script>
</body>
</html>
